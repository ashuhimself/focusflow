name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST "cd ~/focusflow && git fetch origin && git reset --hard origin/main && echo 'DEBUG=False' > .env && echo 'DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY' >> .env && echo 'ALLOWED_HOSTS=breathingmonk.com,www.breathingmonk.com' >> .env && echo 'CORS_ALLOWED_ORIGINS=http://breathingmonk.com,http://www.breathingmonk.com,https://breathingmonk.com,https://www.breathingmonk.com' >> .env && echo 'CSRF_TRUSTED_ORIGINS=http://breathingmonk.com,http://www.breathingmonk.com,https://breathingmonk.com,https://www.breathingmonk.com' >> .env && echo 'POSTGRES_DB=focusflow' >> .env && echo 'POSTGRES_USER=focusflow' >> .env && echo 'POSTGRES_PASSWORD=$POSTGRES_PASSWORD' >> .env && echo 'VITE_API_URL=https://breathingmonk.com/api' >> .env && echo 'FRONTEND_URL=https://breathingmonk.com' >> .env && echo 'EMAIL_HOST=smtp.gmail.com' >> .env && echo 'EMAIL_PORT=587' >> .env && echo 'EMAIL_USE_TLS=True' >> .env && echo 'EMAIL_HOST_USER=$EMAIL_HOST_USER' >> .env && echo 'EMAIL_HOST_PASSWORD=$EMAIL_HOST_PASSWORD' >> .env && echo 'DEFAULT_FROM_EMAIL=BreathingMonk <noreply@breathingmonk.com>' >> .env && chmod +x deploy.sh && ./deploy.sh"

      - name: Verify Deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
            cd ~/focusflow
            docker-compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Notify Deployment Status
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Application: https://breathingmonk.com"
          echo "ðŸ”§ API: https://breathingmonk.com/api"
          echo "âš™ï¸  Admin: https://breathingmonk.com/admin"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details."
